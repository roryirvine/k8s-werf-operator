configVersion: 1
project: werf-operator
cleanup:
  disableKubernetesBasedPolicy: false
  disableGitHistoryBasedPolicy: true
  disableBuiltWithinLastNHoursPolicy: true
  keepPolicies:
  - references:
      tag: /.*/
      limit:
        last: 10
  - references:
      branch: /^(main|master|staging|production)$/
    imagesPerReference:
      last: 1

---
image: operator
from: python:3.12-slim
fromLatest: true
mount:
  - from: build_dir
    to: /var/caches/apt
  - from: tmp_dir
    to: /var/lib/apt/lists
  - from: tmp_dir
    to: /root/.cache
git:
- add: /src
  to: /app
  stageDependencies:
    install:
    - requirements*.txt
shell:
  beforeInstall:
    - apt-get update
    - apt-get install -y --no-install-recommends libyaml-0-2
    - rm -rf /var/lib/apt/lists/*
  install:
    - pip install --no-cache-dir -r /app/requirements.txt
docker:
  ENV:
    WERF_OPERATOR_TIMER_INTERVAL: 600
    WERF_OPERATOR_TIMER_IDLE: 10
    WERF_OPERATOR_JOBS_TTL: 120
    TERM: xterm
    LC_ALL: en_US.UTF-8
    LANG: en_US.UTF-8
  WORKDIR: /app
  CMD: kopf run --liveness=http://0.0.0.0:8080/healthz werf_operator.py
