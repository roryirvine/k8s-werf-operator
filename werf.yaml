configVersion: 1
project: werf-operator
cleanup:
  disableKubernetesBasedPolicy: false
  disableGitHistoryBasedPolicy: true
  disableBuiltWithinLastNHoursPolicy: true
  keepPolicies:
  - references:
      tag: /.*/
      limit:
        last: 10
  - references:
      branch: /^(main|master|staging|production)$/
    imagesPerReference:
      last: 1

---
image: operator
from: ubuntu:24.04
fromLatest: true
mount:
  - from: build_dir
    to: /var/caches/apt
  - from: tmp_dir
    to: /var/lib/apt/lists
  - from: tmp_dir
    to: /root/.cache
git:
- add: /src
  to: /app
  stageDependencies:
    install:
    - requirements*.txt
shell:
  beforeInstall:
    - apt update
    - apt install python3.12-minimal libyaml-0-2 locales -y
    - sed -i '/en_US.UTF-8/s/^# //g' /etc/locale.gen
    - locale-gen
  install:
    - apt update
    - apt install curl -y
    - mv -v /usr/lib/python3.12/EXTERNALLY-MANAGED ./
    - curl https://bootstrap.pypa.io/get-pip.py | python3.12
    - mv -v ./EXTERNALLY-MANAGED /usr/lib/python3.12/
    - apt remove curl -y
    - apt autoremove -y
  setup:
    - apt update
    - apt install python3.12-dev libyaml-dev -y
    - mv -v /usr/lib/python3.12/EXTERNALLY-MANAGED ./
    - pip install -r/app/requirements.txt setuptools
    - mv -v ./EXTERNALLY-MANAGED /usr/lib/python3.12/
    - apt remove python3.12-dev libyaml-dev -y
    - apt autoremove -y
docker:
  ENV:
    WERF_OPERATOR_TIMER_INTERVAL: 600
    WERF_OPERATOR_TIMER_IDLE: 10
    WERF_OPERATOR_JOBS_TTL: 120
    TERM: xterm
    LC_ALL: en_US.UTF-8
    LANG: en_US.UTF-8
  WORKDIR: /app
  CMD: kopf run --liveness=http://0.0.0.0:8080/healthz werf_operator.py
